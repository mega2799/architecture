/*******************************************************************************
*                                                                              *
*                   Architetture dei sistemi di Elaborazione                   *
*                                                                              *
********************************************************************************

Elaborato 2
Descrizione: Dato un insieme di n punti m-dimensionali, scomporre in fattori
			 primi il prodotto degli indici del punto più vicino e di quello
			 più lontano rispetto a un punto p.

Note:
- I valori delle coordinate dei vari punti sono compresi nell’intervallo
  [-100;100].
- Per trovare la distanza minima e massima non è necessario calcolare la
  radice quadrata.
- I fattori primi devono essere riportati nell'array in ordine crescente.

********************************************************************************/

#include <stdio.h>

void main()
{
// Input
//	unsigned int m = 2;			
//	short pointP[] = { 0,0 };								//Punto p
//	short pointset[] = {  42, -53,  96,  78, 1,    1, 100, 100 };	//Array di short contenente
//	short pointset[] = {  1,1,3,4 };	//Array di short contenente
	//short pointset[] = { 1, 1, 3 ,4 };	//Array di short contenente
	//short pointset[] = { -1, 0, 2,0, 3 ,0, 5 ,0, 7 ,0 };	//Array di short contenente
		
	     //    42,		-53, 
	     //    96,		78, 
	     //    1,		1, 
	     //    100,		100


	
///	unsigned int m = 5;
	
//	short pointP []= { -87,84,-84,70,-69 };					//-5,-46,-90,61,-91,5																																																																																																																																																																																																																																																					
				//-5,-46,-90,61,-91,5																																																																																																																																																																																																																																																					
//	short pointset []= { 1,-75,-45,66,23,-78,-64,-54,64,-97,-93,-68,-5,88,-57,-67,25,-86,41,-72,0,-17,64,38,55,25,47,96,-26,-47,45,-46,-47,-25,62,57,93,38,-84,-86,-28,-34,-99,45,77,-83,18,-54,80,39,82,-11,-71,26,32,-82,-38,18,-89,99,-25,-59,72,10,-41,79,-29,39,79,-29,-86,-6,-22,73,71,-66,-19,-81,61,37,-94,0,-85,35,-29,-45,-76,28,44,44,-5,-25,27,-82,39,-69,-6,-8,-14,98,46,79,-33,9,24,-12,-89,-44,55,-3,37,-57,57,-26,92,76,-75,-64,-62,-97,54,44,95,-65,76,39,68,-40,-67,40,40,90,33,64,92,-73,-68,7,-89,84,-56,68,73,-53,-94,-48,19,-48,-74,64,-95,-43,-47,-18,-57,-99,84,-68,33,85,21,52,-77,-85,58,48,10,93,-17,64,43,19,-75,-46,60,86,72,48,-72,24,-80,15,-67,-30,35,-18,36,-50,20,90,-56,-100,75,-74,-37,-7,45,57,-10,-42,42,26,69,-37,-79,-13,-68,99,23,-43,-71,-64,-97,-92,65,-95,18,53,-19,-25,-88,-40,-28,-6,20,43,45,100,92,-34,-60,-86,-42,71,82,-6,46,70,-51,-53,-50,37,27,-37,60,-93,97,66,-39,-42,75,93,-24,-85,-54,-18,-46,-25,43,-22,43,-68,-93,-43,-84,-86,78,-67,-73,-30,-41,48,4,-67,-76,-25,33,-91,34,12,46,79,38,34,-8,-52,39,-57,24,0,-60,-29,-74,71,5,-82,30,-30,-54,45,-70,64,38,91,99,-74,-11,-57,91,71,50,-56,42,-69,33,64,-5,-26,65,69,-24,35,9,28,-70,89,21,33,29,-94,46,-38,63,89,-18,83,-60,47,36,-35,60,-4,-48,53,50,96,30,96,-62,41,23,-44,5,-22,-31,-5,-46,-90,61,-91,5,56,14,85,-75,-13,-19,53,50,51 };

unsigned int m = 15;
short pointP []= { 45,-45,15,-30,76,32,25,63,32,-27,-81,-15,28,-74,-97 };
short pointset []= { 45,-45,15,-30,76,32,25,63,32,-27,-81,-15,28,-74,-97 };
//short pointset[] = { 52,69,8,-12,-35,-86,-14,38,25,61,-67,42,-42,-68,-98,-60,20,-30,-94,-15,-41,-35,-82,-62,3,-52,-89,-63,56,-93,40,94,-30,34,5,-24,3,-12,78,-55,-41,18,91,10,42,90,-34,31,29,-68,0,-85,22,41,44,-14,51,-31,86,-84,-97,-52,82,18,-80,-60,-28,24,27,26,37,-69,-8,61,-74,42,-25,8,-4,14,83,-20,8,24,7,25,-28,29,91,-82,26,-66,3,61,-59,-90,37,-28,-10,2,17,43,-96,-97,-5,-32,23,61,15,-98,-89,-57,74,-29,-66,23,41,-43,-90,-4,68,44,34,8,-100,3,29,32,20,-84,-95,-98,-83,94,97,-61,-24,5,-72,-61,-99,12,-86,89,-93,-18,-40,-69,26,19,-30,-21,-39,95,35,74,-91,-4,-97,93,40,92,-59,-2,97,-91,-75,80,-25,95,-53,-65,-71,72,-6,-44,29,45,1,18,-58,-3,-95,-100,46,26,41,-77,-41,-78,-70,80,2,-64,0,-91,-29,16,92,99,-43,-19,57,31,-29,-66,-50,-10,0,-22,-56,-36,96,-15,50,-57,87,-60,52,-30,-32,-98,20,-48,65,-33,34,93,-28,-15,86,-87,54,3,-39,62,40,-26,30,12,-24,-49,23,81,78,67,85,-84,-14,-43,-77,-69,64,22,30,-46,61,4,67,-96,1,-43,-82,-85,-7,-69,11,-8,-76,89,3,12,11,-60,95,-83,-20,40,-25,99,-17,17,7,-85,-39,55,-50,-68,73,-94,-100,-65,8,25,-89,-82,-67,7,-12,47,-44,-8,92,-3,54,12,20,23,28,13,75,-79,-71,69,22,84,50,-97,55,39,81,-21,19,-82,89,-33,-96,86,-71,76,85,73,-49,28,42,91,25,-90,-39,50,-66,28,5,-40,-68,80,-94,39,-97,-73,-31,-71,53,49,67,78,73,74,9,-13,7,35,-6,52,29,-99,70,1,-74,31,-42,40,42,-96,5,-47,75,-41,86,-92,-40,-35,83,-99,6,55,-81,3,62,65,-83,52,2,75,-58,-1,-67,53,32,-70,-91,6,12,-28,70,30,-12,48,-56,13,-97,14,88,0,-74,-59,53,-8,-54,75,82,-33,39,-38,13,7,-63,67,63,-95,-81,-79,28,56,100,55,53,10,-68,77,-34,-28,-41,-51,62,4,64,-99,49,-99 };

//le coordinate degli n punti
								//Numero delle dimensioni di
															//ogni punto
	unsigned int n = sizeof(pointset) / (sizeof(pointset[0]) * m); //Numero di punti
	//	4 
	unsigned int numbers = sizeof(pointset) / sizeof(pointset[0]);

	// Output
	unsigned short indiceMin; 	//Indice del punto più vicino a p
	unsigned short indiceMax; 	//Indice del punto più lontano da p
	unsigned int prodotto; 		//Prodotto degli indici del punto più vicino e del punto
									//più lontano
	unsigned int fattori[100];	//Fattori primi trovati
	unsigned int numFattori;	// Numero dei fattori trovati

	// Blocco assembler
	__asm
	{
		//pulizia variabili 
		mov   indiceMin,0
		mov   indiceMax,0
		mov   prodotto,0
		mov   fattori,0
		mov   numFattori,0
	xor edi,edi
	push 0         		//esp piu lontano 
	push 0				//esp+4 indice max 
	push 99999			//esp+8 più vicino
	push 0            	//esp+12 indice più vicino
	push 0				

	xor esi,esi 
	xor ebx,ebx
	////
	ciclone:
	
		xor ecx,ecx 
		xor edi,edi 
		ciclo:
		mov dx,pointP[ecx*2]
		inc ecx 
		mov ax,pointset[esi*2]		//
		inc esi 
		sub dx, ax				    // x-x_1-x_2......
		imul dx, dx
		add edi,edx					//edi è sqrt(edi)
		cmp ecx,m
		jne ciclo

		mov eax,edi 
		//trovare il massimo//
		mov ecx,[esp]
		cmp ecx,eax
		jg no_max 
		mov [esp],eax 
		mov [esp+4],ebx
		no_max :
		//trovare il minimo //
		cmp eax,[esp+8]
		jge no_min
		mov [esp+8],eax
		mov [esp+12],ebx 
		no_min:
		//salvare indice//
		//dec ebx
		////
		inc ebx
		///
		cmp ebx,n
		jne ciclone 

		mov ax,[esp+12]//piu vicino
		mov indiceMin,ax 
		mov bx,[esp+4]//piu lontano
		mov indiceMax,bx 
		imul ax,bx
		//non tutti i 32 bit == eax 
		//mov prodotto, eax			
		xor ebx,ebx 
		mov bx,ax		//sistemo nel caso eax fosse sporco 0001 1111 => 0000 1111
		mov prodotto, ebx			
			
		xor ecx,ecx
		cmp ax,0 
		je end 
		/////////fattori primi 
		
		xor ebx,ebx 
		xor esi,esi
		xor edx,edx 

		mov ecx,2
		rotation:
		cmp ax,1
		je end //finito di cercare i num primi 
		mov[esp], ax
		idiv cx			//ecx o cx ???
		cmp dx, 0
		//je rotation
		je zero
		inc ecx
		mov ax,[esp]
		mov dl,0
		jmp rotation 
		
		zero:
		mov fattori[esi * 4], ecx	//ecx = conta = 2 
		inc esi
		//inc ecx
		jmp rotation

			end :
		cmp eax,0
		jne n_zero
		mov numFattori,0
		jmp real_end 
		n_zero:
		mov numFattori,esi 
		real_end: 
		pop eax
		pop eax
		pop eax
		pop eax
		pop eax
	}

	// Stampa su video
	printf("Indice del punto piu' vicino a p: %d\n", indiceMin);
	printf("Indice del punto piu' lontano da p: %d\n", indiceMax);
	printf("Prodotto degli indici: %d\n", prodotto);
	printf("Numero di fattori primi=%d\n", numFattori);
	for (unsigned int i = 0; i < numFattori; i++)
		printf("%d\n", fattori[i]);
	return;
}


/*


Caso di prova fallito:
m=5
n=74
pointP={-87,84,-84,70,-69}
pointset={1,-75,-45,66,23,     -78,-64,-54,64,-97,            -93,-68,-5,88,-57,          -67,25,-86,41,-72,              0,-17,64,38,55,            25,47,96,-26,-47,45,-46,-47,-25,62,57,93,38,-84,-86,-28,-34,-99,45,77,-83,18,-54,80,39,82,-11,-71,26,32,-82,-38,18,-89,99,-25,-59,72,10,-41,79,-29,39,79,-29,-86,-6,-22,73,71,-66,-19,-81,61,37,-94,0,-85,35,-29,-45,-76,28,44,44,-5,-25,27,-82,39,-69,-6,-8,-14,98,46,79,-33,9,24,-12,-89,-44,55,-3,37,-57,57,-26,92,76,-75,-64,-62,-97,54,44,95,-65,76,39,68,-40,-67,40,40,90,33,64,92,-73,-68,7,-89,84,-56,68,73,-53,-94,-48,19,-48,-74,64,-95,-43,-47,-18,-57,-99,84,-68,33,85,21,52,-77,-85,58,48,10,93,-17,64,43,19,-75,-46,60,86,72,48,-72,24,-80,15,-67,-30,35,-18,36,-50,20,90,-56,-100,75,-74,-37,-7,45,57,-10,-42,42,26,69,-37,-79,-13,-68,99,23,-43,-71,-64,-97,-92,65,-95,18,53,-19,-25,-88,-40,-28,-6,20,43,45,100,92,-34,-60,-86,-42,71,82,-6,46,70,-51,-53,-50,37,27,-37,60,-93,97,66,-39,-42,75,93,-24,-85,-54,-18,-46,-25,43,-22,43,-68,-93,-43,-84,-86,78,-67,-73,-30,-41,48,4,-67,-76,-25,33,-91,34,12,46,79,38,34,-8,-52,39,-57,24,0,-60,-29,-74,71,5,-82,30,-30,-54,45,-70,64,38,91,99,-74,-11,-57,91,71,50,-56,42,-69,33,64,-5,-26,65,69,-24,35,9,28,-70,89,21,33,29,-94,46,-38,63,89,-18,83,-60,47,36,-35,60,-4,-48,53,50,96,30,96,-62,41,23,-44,5,-22,-31,-5,-46,-90,61,-91,5,56,14,85,-75,-13,-19,53,50,51}
Risultato corretto:
indiceMin=3
indiceMax=69
prodotto=207
numFattori=3
fattori={3,3,23}

*/

/*
Caso di prova fallito:
m=15
n=30
pointP={45,-45,15,-30,76,32,25,63,32,-27,-81,-15,28,-74,-97}
pointset={52,69,8,-12,-35,-86,-14,38,25,61,-67,42,-42,-68,-98,-60,20,-30,-94,-15,-41,-35,-82,-62,3,-52,-89,-63,56,-93,40,94,-30,34,5,-24,3,-12,78,-55,-41,18,91,10,42,90,-34,31,29,-68,0,-85,22,41,44,-14,51,-31,86,-84,-97,-52,82,18,-80,-60,-28,24,27,26,37,-69,-8,61,-74,42,-25,8,-4,14,83,-20,8,24,7,25,-28,29,91,-82,26,-66,3,61,-59,-90,37,-28,-10,2,17,43,-96,-97,-5,-32,23,61,15,-98,-89,-57,74,-29,-66,23,41,-43,-90,-4,68,44,34,8,-100,3,29,32,20,-84,-95,-98,-83,94,97,-61,-24,5,-72,-61,-99,12,-86,89,-93,-18,-40,-69,26,19,-30,-21,-39,95,35,74,-91,-4,-97,93,40,92,-59,-2,97,-91,-75,80,-25,95,-53,-65,-71,72,-6,-44,29,45,1,18,-58,-3,-95,-100,46,26,41,-77,-41,-78,-70,80,2,-64,0,-91,-29,16,92,99,-43,-19,57,31,-29,-66,-50,-10,0,-22,-56,-36,96,-15,50,-57,87,-60,52,-30,-32,-98,20,-48,65,-33,34,93,-28,-15,86,-87,54,3,-39,62,40,-26,30,12,-24,-49,23,81,78,67,85,-84,-14,-43,-77,-69,64,22,30,-46,61,4,67,-96,1,-43,-82,-85,-7,-69,11,-8,-76,89,3,12,11,-60,95,-83,-20,40,-25,99,-17,17,7,-85,-39,55,-50,-68,73,-94,-100,-65,8,25,-89,-82,-67,7,-12,47,-44,-8,92,-3,54,12,20,23,28,13,75,-79,-71,69,22,84,50,-97,55,39,81,-21,19,-82,89,-33,-96,86,-71,76,85,73,-49,28,42,91,25,-90,-39,50,-66,28,5,-40,-68,80,-94,39,-97,-73,-31,-71,53,49,67,78,73,74,9,-13,7,35,-6,52,29,-99,70,1,-74,31,-42,40,42,-96,5,-47,75,-41,86,-92,-40,-35,83,-99,6,55,-81,3,62,65,-83,52,2,75,-58,-1,-67,53,32,-70,-91,6,12,-28,70,30,-12,48,-56,13,-97,14,88,0,-74,-59,53,-8,-54,75,82,-33,39,-38,13,7,-63,67,63,-95,-81,-79,28,56,100,55,53,10,-68,77,-34,-28,-41,-51,62,4,64,-99,49,-99}
Risultato corretto:
indiceMin=18
indiceMax=25
prodotto=450
numFattori=5
fattori={2,3,3,5,5}

*/